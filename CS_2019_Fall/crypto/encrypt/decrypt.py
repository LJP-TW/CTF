from sympy import *

def rev_op2(c, k):
    return bytes([i ^ j for i, j in zip(c, k)])

def rev_op3(c, rev_p):
    return bytes([c[rev_p[i]] for i in range(len(c))])

def rev_op4(c, rev_s):    
    return bytes(rev_s[x] for x in c)

def rev_stage0(c):
    # stage0_k.py
    k = [142, 97, 45, 175, 112, 157, 238, 137, 114, 214, 34, 143, 72, 175, 56, 100]
    m = b''
    for _c, _k in zip(c, k):
        m += bytes([_c ^ _k])
    return m

def rev_stage1(c):
    k = [239, 194, 15, 76, 81, 87, 59, 247, 160, 19, 227, 201, 119, 125, 116, 166]
    p = [2, 11, 8, 5, 7, 12, 6, 13, 14, 9, 3, 10, 15, 1, 0, 4]
    s = [190, 179, 242, 216, 15, 240, 76, 136, 237, 164, 78, 75, 63, 204, 192, 147, 87, 137, 124, 183, 117, 139, 140, 201, 213, 160, 171, 44, 58, 26, 71, 247, 20, 103, 72, 220, 246, 109, 163, 4, 130, 68, 18, 52, 40, 227, 66, 6, 143, 31, 2, 45, 114, 131, 108, 233, 102, 232, 77, 217, 32, 199, 96, 166, 56, 189, 218, 11, 250, 36, 21, 243, 5, 30, 226, 110, 150, 145, 70, 34, 162, 116, 215, 181, 46, 67, 29, 174, 156, 208, 133, 73, 95, 195, 64, 180, 224, 241, 47, 118, 184, 19, 112, 85, 159, 106, 239, 97, 89, 25, 157, 92, 229, 142, 167, 41, 126, 141, 127, 223, 149, 244, 98, 178, 119, 203, 33, 91, 121, 79, 83, 100, 211, 153, 74, 155, 231, 219, 221, 176, 38, 0, 88, 39, 42, 236, 12, 8, 138, 13, 209, 128, 251, 35, 1, 14, 59, 60, 54, 129, 7, 90, 187, 182, 115, 210, 154, 191, 113, 212, 235, 94, 65, 249, 245, 120, 55, 186, 123, 146, 197, 148, 37, 169, 57, 111, 230, 194, 107, 254, 81, 125, 93, 17, 43, 248, 9, 27, 69, 28, 99, 61, 50, 172, 207, 135, 48, 253, 16, 177, 23, 168, 134, 225, 202, 205, 158, 165, 175, 62, 152, 144, 86, 185, 22, 161, 188, 51, 101, 104, 238, 228, 200, 206, 53, 10, 196, 105, 234, 84, 151, 222, 3, 252, 24, 170, 198, 173, 193, 49, 214, 255, 122, 132, 80, 82]
    rev_p = {v: i for i ,v in enumerate(p)}
    rev_s = {v: i for i, v in enumerate(s)}

    m = c
    for i in range(16):
        m = rev_op4(m, rev_s)
        m = rev_op3(m, rev_p)
        m = rev_op2(m, k)
    return m

def decrypt(c, key):
    stage = [rev_stage0, rev_stage1]
    for i in list(map(int, f'{key:08b}'))[::-1]:
        c = stage[i](c)
    return c

if __name__ == '__main__':
    c = b'\x97\x97\x31\x9b\x8b\x80\xb2\xfa\xe7\xac\x67\x77\xb2\x16\xbc\x60'
    for bfkey in range(256):
        m = decrypt(c, bfkey)
        print(f'{bfkey:4d} : {m}')

